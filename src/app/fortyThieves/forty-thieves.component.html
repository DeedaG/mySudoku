<!-- Controls Row -->
<div class="controls-row">
  <h2 style="color: black;">Forty Thieves</h2>
  <button (click)="startGame()">üÉè New Game</button>
  <button (click)="goBack()">Back to Main</button>
</div>

<!-- Game Container -->
<div class="forty-thieves-game" (pointermove)="onPointerMove($event)">

  <!-- End Messages -->
  @if(solved) {
    <div class="end-message">
      <div>
        üéâ Congratulations! 
        <br>
        <span style="font-size: 20px;">You won in {{formattedTime}} minutes!</span>
      </div>
    </div>
  }

  @if(checkGameOver() && viewReady) {
    <div class="end-message">
      <div>
        No Cards Left
        <br>
        <h2>Game Over</h2>
        <br>
        <button class="new-game" (click)="startGame()">New Game</button>
      </div>
    </div>
  }

  <!-- Top Row: Stock/Waste left, Foundations right -->
  <div class="top-row">
    <!-- Left: Stock & Waste -->
    <div class="stock-waste-row">
      <div class="stock" (click)="drawFromStock()">
        {{ piles.stock.cards.length }} left
      </div>

      <div class="waste"
           [attr.data-pile-id]="piles.waste.id"
           [attr.data-pile-name]="piles.waste.name"
           (pointerup)="dropOnPile($event)">
        @if(piles.waste.top()){
          <div class="card"
               [class.facedown]="!piles.waste.top()?.faceUp"
               [class.red]="piles.waste.top()?.suit === '‚ô•' || piles.waste.top()?.suit === '‚ô¶'"
               [class.black]="piles.waste.top()?.suit === '‚ô†' || piles.waste.top()?.suit === '‚ô£'"
               (pointerdown)="startDrag(piles.waste, $event, piles.waste.top())">
            {{ piles.waste.top()?.display }}
          </div>
        }
      </div>
    </div>

    <!-- Right: Foundation Piles -->
    <div class="foundations-row">
      @for(p of piles.foundation; track trackByIndex($index, p); let i = $index){
        <div class="foundation-pile"
             [attr.data-pile-id]="p.id"
             [attr.data-pile-name]="p.name"
             (pointerup)="dropOnPile($event)">
          {{p.suit}}
          @if(p.top()){
            <div class="card"
              [class.red]="p.suit === '‚ô•' || p.suit === '‚ô¶'"
              [class.black]="p.suit === '‚ô†' || p.suit === '‚ô£'"
            >{{ p.top()?.display }}</div>
          }
        </div>
      }
    </div>
  </div>

  <!-- Tableau -->
  <div class="tableau-row">
    @for(p of piles.tableau; track trackByIndex($index, p); let i = $index){
      <div class="pile tableau-pile"
           [attr.data-pile-id]="p.id"
           [attr.data-pile-name]="p.name"
           (pointerup)="dropOnPile($event)">
        @for(card of p.cards; track trackByIndex($index, card); let j = $index){
          <div class="card-tableau"
               [class.facedown]="!card.faceUp"
               [class.red]="card.suit === '‚ô•' || card.suit === '‚ô¶'"
               [class.black]="card.suit === '‚ô†' || card.suit === '‚ô£'"
               (pointerdown)="startDrag(p, $event, card)">
                @if (card.faceUp) {
                  <div class="rank">
                    {{
                      card.rank === 1 ? 'A' :
                      card.rank === 11 ? 'J' :
                      card.rank === 12 ? 'Q' :
                      card.rank === 13 ? 'K' :
                      card.rank
                    }}
                  </div>
                  <div class="suit">{{ card.suit }}</div>
                } 
          </div>
        }
      </div>
    }
  </div>

  <!-- Dragged Card -->
  @if(draggedCard){
    <div class="dragged-card"
         [style.top.px]="dragY"
         [style.left.px]="dragX"
         [class.red]="draggedCard.suit === '‚ô•' || draggedCard.suit === '‚ô¶'"
         [class.black]="draggedCard.suit === '‚ô†' || draggedCard.suit === '‚ô£'">
      {{ draggedCard.display }}
    </div>
  }

</div>
